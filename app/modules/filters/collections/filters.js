'use strict';

var _ = require('underscore');
var Backbone = require('backbone');
var Filter = require('../models/filter');
var utils = require('../../../../shared/utils');
var config = require('../config');
var transformers = require('../transformers');

var filters = utils.get(config, ['filters'], {});
var sorts = utils.get(config, ['sorts'], {});
var defaultOrderByName = Object.keys(filters);
var defaultOrderByType = ['BOOLEAN', 'SELECT', 'RANGE'];
var regexpReplace = /-([a-zA-Z0-9]+)_([a-zA-Z0-9_\.\+\*]*)/g;
var regexpFind = /-[a-zA-Z0-9]+_[a-zA-Z0-9_\.\+\*]*/g;
var regexpSort = /([a-zA-Z0-9_]*)(desc)/g;
var booleans = ['true', 'false'];
var Base;

Backbone.noConflict();
Base = Backbone.Collection;

function initialize(models, options) {
    this.options = options || {};
    this.app = this.options.app;
    if (this.options.path) {
        this.load(this.options.path);
    }
}

function isActive(name) {
    var filter = this.get(name);
    var exists = !!filter;

    if (exists) {
        exists = filter.has('current');
    }
    return exists;
}

function has(name, value) {
    var filter = this.get(name);
    var exists = !!filter;

    if (exists && !_.isUndefined(value)) {
        switch (filter.get('type')) {
            case 'SELECT':
                exists = _.contains(filter.get('current'), value);
                break;
            case 'RANGE':
                exists = (filter.has('current') && filter.get('current')[value]);
                break;
            case 'BOOLEAN':
                exists = (filter.get('current') === value);
                break;
        }
    }
    return exists;
}

function addAll(filters, options) {
    _.each(filters, function(filter, i) {
        _add.call(this, filter, options);
    }, this);
    return this;
}

function addSelect(_filter) {
    var filter = this.get(_filter.name);

    if (filter) {
        if (!filter.has('current')) {
            filter.set({
                current: []
            }, {
                merge: true
            });
        }
        filter.get('current').push(_filter.value);
        return _add.call(this, filter);
    }
    filter = _.clone(_filter);
    filter.current = [filter.value];
    delete filter.value;
    return _add.call(this, filter);
}

function add(filter, options) {
    if (filter instanceof Filter) {
        return _add.call(this, filter, options);
    }
    if (filter.type === 'SELECT') {
        if (this.has(filter.name, filter.value)) {
            return;
        }
        return addSelect.call(this, filter);
    }
    filter = _.clone(filter);
    filter.current = filter.value;
    delete filter.value;
    return _add.call(this, filter);
}

function _add(filter, options) {
    var tFilter;

    if (!(filter instanceof Filter)) {
        filter = new Filter(filter, {
            app: this.app
        });
    }
    tFilter = checkTransform.call(this, filter);
    if (!tFilter) {
        return this.remove(filter);
    }
    return Base.prototype.add.call(this, tFilter, options || {
        merge: true
    });
}

function checkTransform(filter) {
    var transformer = transformers.byType[filter.get('type')];

    if (transformer) {
        filter = transformer.call(this, filter, {
            app: this.app
        });
    }
    transformer = transformers.byName[filter.get('name')];
    if (transformer) {
        filter = transformer.call(this, filter, {
            app: this.app
        });
    }
    return filter;
}

function removeAll(filters, options) {
    _.each(filters, function(filter, i) {
        _remove.call(this, filter, options);
    }, this);
    return this;
}

function removeSelect(_filter) {
    var filter;
    var value;

    if (this.has(_filter.name, _filter.value)) {
        filter = this.get(_filter.name);

        if (_filter.value) {
            value = _.filter(filter.get('current'), function(value) {
                return value !== _filter.value;
            });
        }
        else {
            value = [];
        }

        if (!value.length) {
            return _remove.call(this, filter);
        }
        else {
            return _add.call(this, {
                name: filter.get('name'),
                current: value
            });
        }
    }
}

function remove(filter, options) {
    if (_.isArray(filter)) {
        return removeAll.call(this, filter, options);
    }
    if (filter instanceof Filter) {
        return _remove.call(this, filter, options);
    }
    if (filter.type === 'SELECT') {
        return removeSelect.call(this, filter);
    }
    return _remove.call(this, filter);
}

function _remove(filter, options) {
    if (!(filter instanceof Filter)) {
        filter = new Filter(filter, {
            app: this.app
        });
    }
    return Base.prototype.remove.call(this, filter, options);
}

function parseValue(value, type) {
    switch (type) {
        case 'SELECT':
            return value.split('_');
        case 'RANGE':
            return _.object(['from', 'to'], value.split('_'));
        case 'BOOLEAN':
            return value;
    }
}

function parseFilter(filter) {
    var keyValue = filter.replace(regexpReplace, '$1#$2');

    keyValue = keyValue.split('#');
    filter = {
        name: keyValue[0]
    };
    filter.type = filters[filter.name].type;
    filter.current = parseValue(keyValue[1], filter.type);
    return filter;
}

function load(url) {
    var listFilters = (url.match(regexpFind) || []);

    _.each(listFilters, function parseFilters(filter, i) {
        filter = parseFilter(filter);
        this.add(new Filter(filter, {
            app: this.app
        }));
    }, this);
    return this;
}

function format() {
    var url = [];
    var value;
    var name;
    var type;
    var sort;

    this.each(function(filter) {
        name = filter.get('name');
        type = filter.get('type');
        if (!filter.has('current') || name === 'sort') {
            return;
        }
        url.push('-');
        url.push(name);
        url.push('_');
        value = filter.get('current');
        if (transformers[type] && transformers[type].format) {
            value = transformers[type].format(value);
        }
        switch (type) {
            case 'RANGE':
                url.push(value.from);
                url.push('_');
                url.push(value.to);
                break;
            case 'SELECT':
                url.push(value.join('_'));
                break;
            case 'BOOLEAN':
                url.push(value);
                break;
        }
    });
    if (this.has('sort')) {
        sort = this.get('sort').get('current').join('');
        if (sorts[sort]) {
            url.push('-sort_');
            url.push(sort);
        }
    }
    return url.join('');
}

function smaugize() {
    var params = {};
    var sort;
    var name;
    var type;
    var value;

    if (!this.length) {
        return params;
    }
    this.each(function(filter) {
        name = filter.get('name');
        type = filter.get('type');
        value = filter.get('current');

        if (value === 'false' || name === 'sort') {
            return;
        }
        name = 'f.' + name;
        if (transformers[type] && transformers[type].smaugize) {
            value = transformers[type].smaugize(value);
        }
        switch (type) {
            case 'SELECT':
                params[name] = value.join(utils.get(filters, [filter.get('name'), 'options', 'separator'], 'OR'));
                break;
            case 'RANGE':
                params[name] = [value.from, 'TO', value.to].join('');
                break;
            case 'BOOLEAN':
                params[name] = value;
                break;
        }
    });
    if (this.has('sort')) {
        sort = this.get('sort');
        sort = sort.get('current').join('').replace(regexpSort, '$1#$2').split('#');
        if (sorts[sort[0]]) {
            params['s.' + sort[0]] = sort[1] || 'asc';
        }
    }
    return params;
}

function checkComparator(options) {
    options = options || {};
    if (options.sortType) {
        switch(options.sortType) {
            case 'type':
                this.order = options.order || this.order || defaultOrderByType;
                this.comparator = comparatorByType;
                break;
            default:
                this.order = options.order || this.order || defaultOrderByName;
                this.comparator = comparatorByName;
                break;
        }
    }
}

function toJSON(options) {
    checkComparator.call(this, options);
    return this.sort().map(function(model) {
        return model.toJSON(options);
    });
}

function getIndex(name, defaultOrder) {
    var indexOf = this.order.indexOf(name);

    if (!~indexOf) {
        return defaultOrder.indexOf(name);
    }
    return indexOf - 100;
}

function comparator(filterA, filterB, property, defaultOrder) {
    var indexOfA = getIndex.call(this, filterA.get(property), defaultOrder);
    var indexOfB = getIndex.call(this, filterB.get(property), defaultOrder);

    if (indexOfA > indexOfB) {
        return 1;
    }
    else if (indexOfB > indexOfA) {
        return -1;
    }
    return 0;
}

function comparatorByName(filterA, filterB) {
    return comparator.call(this, filterA, filterB, 'name', defaultOrderByName);
}

function comparatorByType(filterA, filterB) {
    return comparator.call(this, filterA, filterB, 'type', defaultOrderByType);
}

module.exports = Base.extend({
    model: Filter,
    order: defaultOrderByName,
    comparator: comparatorByName,
    initialize: initialize,
    isActive: isActive,
    has: has,
    add: add,
    addAll: addAll,
    remove: remove,
    removeAll: removeAll,
    load: load,
    format: format,
    smaugize: smaugize,
    toJSON: toJSON
});

module.exports.id = 'Filters';
